
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saalplan-Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .controls {
            padding: 10px;
            background: #f9f9f9;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .button-separator {
            width: 1px;
            height: 24px;
            background: #ddd;
            margin: 0 5px;
        }

        .background-upload {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .background-upload input[type="file"] {
            font-size: 11px;
        }

        .background-upload button {
            width: auto;
            padding: 4px 8px;
            font-size: 11px;
        }

        .control-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 12px;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="number"],
        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 120px;
        }

        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 32px;
            height: 32px;
            padding: 6px;
            background: white;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        button:hover {
            background: #f8f9fa;
            border-color: #999;
            box-shadow: 0 2px 6px rgba(0,0,0,0.12);
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }

        button:disabled {
            background: #f5f5f5;
            border-color: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.5;
            transform: none;
        }

        button:disabled:hover {
            background: #f5f5f5;
            border-color: #e0e0e0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            transform: none;
        }

        button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        button.active:hover {
            background: #5568d3;
            border-color: #5568d3;
        }

        button svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .btn-secondary {
            border-color: #6c757d;
            color: #6c757d;
        }

        .btn-secondary:hover {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            border-color: #28a745;
            color: #28a745;
        }

        .btn-success:hover {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            border-color: #dc3545;
            color: #dc3545;
        }

        .btn-danger:hover {
            background: #dc3545;
            color: white;
        }

        .workspace {
            display: flex;
            height: calc(100vh - 300px);
            min-height: 600px;
        }

        .canvas-wrapper {
            flex: 1;
            position: relative;
            overflow: auto;
            background: #fafafa;
        }

        #canvas {
            display: block;
            cursor: crosshair;
            background: white;
        }

        .sidebar {
            width: 300px;
            background: #f9f9f9;
            border-left: 1px solid #e0e0e0;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }

        .info-box {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .info-label {
            font-weight: 600;
            color: #666;
        }

        .info-value {
            color: #333;
        }

        .mode-indicator {
            position: relative;
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            margin: 10px auto 0;
            max-width: fit-content;
        }

        .price-categories {
            margin-top: 20px;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .color-box {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            border: 2px solid #333;
        }

        .lasso {
            position: absolute;
            border: 2px dashed #667eea;
            background: rgba(102, 126, 234, 0.1);
            pointer-events: none;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .add-seats-panel {
            background: white;
            padding: 20px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .add-seats-panel h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 5px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            text-transform: none;
            font-weight: normal;
            width: auto;
        }

        .radio-group input[type="radio"] {
            width: auto;
            margin: 0;
        }

        .stats {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            margin-top: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            width: auto;
            height: auto;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .modal-footer button {
            width: auto;
            padding: 10px 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <!-- Einstellungen -->
            <button onclick="editor.openSettingsModal()" title="Einstellungen">
                <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
            </button>

            <div class="button-separator"></div>

            <!-- Modi -->
            <button onclick="editor.openAddSeatsModal()" class="btn-success" title="Plätze hinzufügen">
                <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </button>
            <button onclick="editor.setMode('select')" class="btn-secondary" title="Plätze auswählen">
                <svg viewBox="0 0 24 24"><path d="M3 3h18v18H3V3zm16 16V5H5v14h14z"/></svg>
            </button>
            <button onclick="editor.setMode('info')" title="Info anzeigen">
                <svg viewBox="0 0 24 24"><path d="M11 7h2v2h-2V7zm0 4h2v6h-2v-6zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
            </button>

            <div class="button-separator"></div>

            <!-- Zeichnen -->
            <button id="btnRect" onclick="editor.toggleDrawMode('rect')" title="Rechteck zeichnen">
                <svg viewBox="0 0 24 24"><path d="M3 3h18v18H3V3zm16 16V5H5v14h14z"/></svg>
            </button>
            <button id="btnCircle" onclick="editor.toggleDrawMode('circle')" title="Kreis zeichnen">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
            </button>
            <button id="btnLine" onclick="editor.toggleDrawMode('line')" title="Linie zeichnen">
                <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            </button>
            <button id="btnTriangle" onclick="editor.toggleDrawMode('triangle')" title="Dreieck zeichnen">
                <svg viewBox="0 0 24 24"><path d="M12 2L1 21h22L12 2zm0 3.99L19.53 19H4.47L12 5.99z"/></svg>
            </button>
            <input type="color" id="shapeColor" value="#3498db" title="Zeichenfarbe" style="width: 32px; height: 32px; padding: 2px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">
            <button id="fillModeBtn" onclick="editor.toggleFillMode()" title="Füllung umschalten">
                <svg viewBox="0 0 24 24"><path d="M16.56 8.94L7.62 0 6.21 1.41l2.38 2.38-5.15 5.15c-.59.59-.59 1.54 0 2.12l5.5 5.5c.29.29.68.44 1.06.44s.77-.15 1.06-.44l5.5-5.5c.59-.58.59-1.53 0-2.12zM5.21 10L10 5.21 14.79 10H5.21zM19 11.5s-2 2.17-2 3.5c0 1.1.9 2 2 2s2-.9 2-2c0-1.33-2-3.5-2-3.5z"/></svg>
            </button>
            <button onclick="editor.deleteSelectedShape()" class="btn-danger" title="Form löschen">
                <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            </button>

            <div class="button-separator"></div>

            <!-- Bearbeitung -->
            <button onclick="editor.undo()" id="undoBtn" title="Rückgängig">
                <svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>
            </button>
            <button onclick="editor.clearCanvas()" class="btn-danger" title="Alles löschen">
                <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            </button>

            <div class="button-separator"></div>

            <!-- Import/Export -->
            <button onclick="editor.exportJSON()" class="btn-success" title="Als JSON speichern">
                <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
            </button>
            <button onclick="document.getElementById('importFile').click()" class="btn-secondary" title="JSON laden">
                <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
            </button>
            <button onclick="editor.exportPDF()" class="btn-danger" title="Als PDF exportieren">
                <svg viewBox="0 0 24 24"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/></svg>
            </button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="editor.importJSON(event)" />

            <div class="button-separator"></div>

            <!-- Auswahl-Aktionen -->
            <div id="selectionActions" style="display: none; gap: 5px;">
                <button onclick="editor.setMode('move')" title="Verschieben">
                    <svg viewBox="0 0 24 24"><path d="M10 9h4V6h3l-5-5-5 5h3v3zm-1 1H6V7l-5 5 5 5v-3h3v-4zm14 2l-5-5v3h-3v4h3v3l5-5zm-9 3h-4v3H7l5 5 5-5h-3v-3z"/></svg>
                </button>
                <button onclick="editor.openRotateModal()" title="Drehen">
                    <svg viewBox="0 0 24 24"><path d="M15.55 5.55L11 1v3.07C7.06 4.56 4 7.92 4 12s3.05 7.44 7 7.93v-2.02c-2.84-.48-5-2.94-5-5.91s2.16-5.43 5-5.91V10l4.55-4.45zM19.93 11c-.17-1.39-.72-2.73-1.62-3.89l-1.42 1.42c.54.75.88 1.6 1.02 2.47h2.02zM13 17.9v2.02c1.39-.17 2.74-.71 3.9-1.61l-1.44-1.44c-.75.54-1.59.89-2.46 1.03zm3.89-2.42l1.42 1.41c.9-1.16 1.45-2.5 1.62-3.89h-2.02c-.14.87-.48 1.72-1.02 2.48z"/></svg>
                </button>
                <button onclick="editor.changeSelectedCategory()" class="btn-success" title="Kategorie ändern">
                    <svg viewBox="0 0 24 24"><path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/></svg>
                </button>
                <button onclick="editor.deleteSelected()" class="btn-danger" title="Löschen">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>

            <div class="button-separator"></div>

            <!-- Hintergrundbild -->
            <div class="background-upload">
                <label style="margin: 0;">Hintergrund:</label>
                <input type="file" id="backgroundImage" accept="image/*" onchange="editor.loadBackgroundImage(event)" style="width: auto; min-width: 0;" />
                <button onclick="editor.removeBackgroundImage()" title="Hintergrund entfernen">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
        </div>

        <div class="workspace">
            <div class="canvas-wrapper">
                <canvas id="canvas" width="1200" height="800"></canvas>
            </div>
            <div class="sidebar">
                <div class="info-box">
                    <h3>Platz-Information</h3>
                    <div id="seatInfo">
                        <p style="color: #999; font-size: 13px;">Klicken Sie auf einen Platz im Info-Modus</p>
                    </div>
                </div>

                <div class="stats">
                    <h3>Statistik</h3>
                    <div class="info-row">
                        <span class="info-label">Gesamtplätze:</span>
                        <span class="info-value" id="totalSeats">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Ausgewählt:</span>
                        <span class="info-value" id="selectedSeats">0</span>
                    </div>
                </div>

            </div>
        </div>
        <div class="mode-indicator" id="modeIndicator">Modus: Info</div>
    </div>

    <!-- Modal für Rotation -->
    <div id="rotateModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Plätze drehen</h3>
                <button class="modal-close" onclick="editor.closeRotateModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>Winkel (Grad)</label>
                <input type="number" id="rotationAngle" value="45" min="-360" max="360" step="1" />
                <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                    <button onclick="document.getElementById('rotationAngle').value = '45'" style="width: auto; padding: 5px 10px; font-size: 12px;">45°</button>
                    <button onclick="document.getElementById('rotationAngle').value = '90'" style="width: auto; padding: 5px 10px; font-size: 12px;">90°</button>
                    <button onclick="document.getElementById('rotationAngle').value = '180'" style="width: auto; padding: 5px 10px; font-size: 12px;">180°</button>
                    <button onclick="document.getElementById('rotationAngle').value = '-45'" style="width: auto; padding: 5px 10px; font-size: 12px;">-45°</button>
                    <button onclick="document.getElementById('rotationAngle').value = '-90'" style="width: auto; padding: 5px 10px; font-size: 12px;">-90°</button>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="editor.closeRotateModal()" class="btn-secondary">Abbrechen</button>
                <button onclick="editor.applyRotation()" class="btn-success">Drehen</button>
            </div>
        </div>
    </div>

    <!-- Modal für Einstellungen -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Einstellungen</h3>
                <button class="modal-close" onclick="editor.closeSettingsModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>Canvas Breite (px)</label>
                <input type="number" id="canvasWidth" value="1200" min="800" max="3000" />
            </div>
            <div class="form-group">
                <label>Canvas Höhe (px)</label>
                <input type="number" id="canvasHeight" value="800" min="600" max="2000" />
            </div>
            <div class="form-group">
                <label>Platzgröße (px)</label>
                <input type="number" id="defaultSeatSize" value="30" min="10" max="100" />
            </div>
            <div class="form-group">
                <label>Platzform</label>
                <select id="defaultSeatShape">
                    <option value="circle">Rund</option>
                    <option value="square">Eckig</option>
                </select>
            </div>
            <div class="modal-footer">
                <button onclick="editor.closeSettingsModal()" class="btn-secondary">Abbrechen</button>
                <button onclick="editor.applySettings()" class="btn-success">Übernehmen</button>
            </div>
        </div>
    </div>

    <!-- Modal für Plätze hinzufügen -->
    <div id="addSeatsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Plätze hinzufügen</h3>
                <button class="modal-close" onclick="editor.closeAddSeatsModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>Block</label>
                <input type="text" id="blockName" value="Block A" />
            </div>
            <div class="form-group">
                <label>Startnummer Reihe</label>
                <input type="number" id="startRow" value="1" min="1" />
            </div>
            <div class="form-group">
                <label>Anzahl Reihen</label>
                <input type="number" id="numRows" value="5" min="1" />
            </div>
            <div class="form-group">
                <label>Startnummer Platz</label>
                <input type="number" id="startSeat" value="1" min="1" />
            </div>
            <div class="form-group">
                <label>Anzahl Plätze pro Reihe</label>
                <input type="number" id="numSeats" value="10" min="1" />
            </div>
            <div class="form-group">
                <label>Reihenabstand (px)</label>
                <input type="number" id="rowSpacing" value="10" min="0" />
            </div>
            <div class="form-group">
                <label>Platzabstand (px)</label>
                <input type="number" id="seatSpacing" value="5" min="0" />
            </div>
            <div class="form-group">
                <label>Reihenstruktur</label>
                <select id="rowOrientation">
                    <option value="horizontal">Horizontal</option>
                    <option value="vertical">Vertikal</option>
                </select>
            </div>
            <div class="form-group">
                <label>Reihe 1 Position</label>
                <div class="radio-group">
                    <label><input type="radio" name="row1Pos" value="top" checked /> Oben</label>
                    <label><input type="radio" name="row1Pos" value="bottom" /> Unten</label>
                </div>
            </div>
            <div class="form-group">
                <label>Platz 1 Position</label>
                <div class="radio-group">
                    <label><input type="radio" name="seat1Pos" value="left" checked /> Links</label>
                    <label><input type="radio" name="seat1Pos" value="right" /> Rechts</label>
                </div>
            </div>
            <div class="form-group">
                <label>Preiskategorie</label>
                <select id="priceCategory">
                    <option value="1">Kategorie 1 (Premium)</option>
                    <option value="2">Kategorie 2 (Standard)</option>
                    <option value="3">Kategorie 3 (Budget)</option>
                </select>
            </div>
            <div class="modal-footer">
                <button onclick="editor.closeAddSeatsModal()" class="btn-secondary">Abbrechen</button>
                <button onclick="editor.confirmAddSeats()" class="btn-success">OK - Platzieren</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        class SeatPlanEditor {
            constructor() {
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.seats = [];
                this.selectedSeats = new Set();
                this.mode = 'info'; // 'add', 'select', 'info', 'move'
                this.history = [];
                this.isDrawing = false;
                this.lassoStart = null;
                this.lassoEnd = null;
                this.isDragging = false;
                this.dragStart = null;
                this.dragOffset = { x: 0, y: 0 };
                this.backgroundImage = null;

                // Shape drawing
                this.shapes = [];
                this.currentDrawTool = null;
                this.isDrawingShape = false;
                this.shapeStartX = 0;
                this.shapeStartY = 0;
                this.selectedShape = null;
                this.isDraggingShape = false;
                this.shapeDragOffsetX = 0;
                this.shapeDragOffsetY = 0;
                this.shapeFillMode = false; // false = outline only, true = filled

                // Global settings
                this.settings = {
                    canvasWidth: 1200,
                    canvasHeight: 800,
                    defaultSeatSize: 30,
                    defaultSeatShape: 'circle'
                };

                this.priceColors = {
                    '1': '#ff6b6b',
                    '2': '#4ecdc4',
                    '3': '#95e1d3'
                };

                this.loadFromLocalStorage();
                this.setupEventListeners();
                this.render();
                this.updateStats();
            }

            loadFromLocalStorage() {
                try {
                    const saved = localStorage.getItem('saalplan_seats');
                    if (saved) {
                        this.seats = JSON.parse(saved);
                    }
                    const savedShapes = localStorage.getItem('saalplan_shapes');
                    if (savedShapes) {
                        this.shapes = JSON.parse(savedShapes);
                    }
                    const savedBg = localStorage.getItem('saalplan_background');
                    if (savedBg) {
                        const img = new Image();
                        img.onload = () => {
                            this.backgroundImage = img;
                            this.render();
                        };
                        img.src = savedBg;
                    }
                    const savedSettings = localStorage.getItem('saalplan_settings');
                    if (savedSettings) {
                        this.settings = JSON.parse(savedSettings);
                        this.canvas.width = this.settings.canvasWidth;
                        this.canvas.height = this.settings.canvasHeight;
                    }
                } catch (error) {
                    console.error('Fehler beim Laden aus LocalStorage:', error);
                }
            }

            saveToLocalStorage() {
                try {
                    localStorage.setItem('saalplan_seats', JSON.stringify(this.seats));
                    localStorage.setItem('saalplan_shapes', JSON.stringify(this.shapes));
                    localStorage.setItem('saalplan_settings', JSON.stringify(this.settings));
                    if (this.backgroundImage) {
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = this.backgroundImage.width;
                        tempCanvas.height = this.backgroundImage.height;
                        const tempCtx = tempCanvas.getContext('2d');
                        tempCtx.drawImage(this.backgroundImage, 0, 0);
                        localStorage.setItem('saalplan_background', tempCanvas.toDataURL());
                    }
                } catch (error) {
                    console.error('Fehler beim Speichern in LocalStorage:', error);
                }
            }

            setupEventListeners() {
                this.canvas.addEventListener('mousedown', this.handleMouseDown.bind(this));
                this.canvas.addEventListener('mousemove', this.handleMouseMove.bind(this));
                this.canvas.addEventListener('mouseup', this.handleMouseUp.bind(this));
                this.canvas.addEventListener('click', this.handleClick.bind(this));
                document.addEventListener('keydown', this.handleKeyDown.bind(this));
            }

            handleKeyDown(e) {
                // Return/Enter: Verschiebe-Modus beenden
                if (e.key === 'Enter' && this.mode === 'move') {
                    this.selectedSeats.clear();
                    this.setMode('info');
                }
                // ESC: Auswahl aufheben und zurück zum Info-Modus
                else if (e.key === 'Escape') {
                    if (this.mode === 'select' || this.mode === 'move') {
                        this.selectedSeats.clear();
                        this.setMode('info');
                    }
                }
            }

            handleMouseDown(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                if (this.currentDrawTool) {
                    // Check if clicking on existing shape for selection/dragging
                    this.selectedShape = null;
                    for (let i = this.shapes.length - 1; i >= 0; i--) {
                        if (this.isPointInShape(x, y, this.shapes[i])) {
                            this.selectedShape = i;
                            this.isDraggingShape = true;
                            this.shapeDragOffsetX = x - this.shapes[i].x;
                            this.shapeDragOffsetY = y - this.shapes[i].y;
                            this.render();
                            return;
                        }
                    }
                    // Start drawing new shape
                    this.isDrawingShape = true;
                    this.shapeStartX = x;
                    this.shapeStartY = y;
                } else if (this.mode === 'add') {
                    this.addSeatsAtPosition(x, y);
                    this.setMode('info');
                } else if (this.mode === 'select') {
                    this.isDrawing = true;
                    this.lassoStart = { x, y };
                    this.lassoEnd = { x, y };
                } else if (this.mode === 'move' && this.selectedSeats.size > 0) {
                    this.isDragging = true;
                    this.dragStart = { x, y };
                }
            }

            openSettingsModal() {
                // Populate current settings
                document.getElementById('canvasWidth').value = this.settings.canvasWidth;
                document.getElementById('canvasHeight').value = this.settings.canvasHeight;
                document.getElementById('defaultSeatSize').value = this.settings.defaultSeatSize;
                document.getElementById('defaultSeatShape').value = this.settings.defaultSeatShape;
                document.getElementById('settingsModal').classList.add('active');
            }

            closeSettingsModal() {
                const modal = document.getElementById('settingsModal');
                if (modal) {
                    modal.classList.remove('active');
                }
            }

            applySettings() {
                const newWidth = parseInt(document.getElementById('canvasWidth').value);
                const newHeight = parseInt(document.getElementById('canvasHeight').value);
                const newSeatSize = parseInt(document.getElementById('defaultSeatSize').value);
                const newSeatShape = document.getElementById('defaultSeatShape').value;

                // Save state for undo
                if (this.seats.length > 0) {
                    this.saveState();
                }

                // Update all existing seats with new size and shape
                this.seats.forEach(seat => {
                    seat.size = newSeatSize;
                    seat.shape = newSeatShape;
                });

                // Update settings
                this.settings.canvasWidth = newWidth;
                this.settings.canvasHeight = newHeight;
                this.settings.defaultSeatSize = newSeatSize;
                this.settings.defaultSeatShape = newSeatShape;

                // Resize canvas
                this.canvas.width = newWidth;
                this.canvas.height = newHeight;

                // Re-render
                this.render();
                this.saveToLocalStorage();

                // Close modal
                this.closeSettingsModal();
            }

            openAddSeatsModal() {
                document.getElementById('addSeatsModal').classList.add('active');
            }

            closeAddSeatsModal() {
                const modal = document.getElementById('addSeatsModal');
                if (modal) {
                    modal.classList.remove('active');
                }
                if (this.mode === 'add') {
                    this.setMode('info');
                }
            }

            confirmAddSeats() {
                this.setMode('add');
                const modal = document.getElementById('addSeatsModal');
                if (modal) {
                    modal.classList.remove('active');
                }
            }

            handleMouseMove(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                if (this.isDraggingShape && this.selectedShape !== null) {
                    this.shapes[this.selectedShape].x = x - this.shapeDragOffsetX;
                    this.shapes[this.selectedShape].y = y - this.shapeDragOffsetY;
                    this.render();
                } else if (this.isDrawingShape) {
                    this.render();
                    this.drawShapePreview(this.shapeStartX, this.shapeStartY, x, y);
                } else if (this.mode === 'select' && this.isDrawing) {
                    this.lassoEnd = { x, y };
                    this.render();
                } else if (this.mode === 'move' && this.isDragging) {
                    const dx = x - this.dragStart.x;
                    const dy = y - this.dragStart.y;

                    this.selectedSeats.forEach(index => {
                        this.seats[index].x += dx;
                        this.seats[index].y += dy;
                    });

                    this.dragStart = { x, y };
                    this.render();
                    this.saveToLocalStorage();
                }
            }

            handleMouseUp(e) {
                if (this.isDraggingShape) {
                    this.isDraggingShape = false;
                    this.saveToLocalStorage();
                    return;
                }

                if (this.isDrawingShape) {
                    const rect = this.canvas.getBoundingClientRect();
                    const endX = e.clientX - rect.left;
                    const endY = e.clientY - rect.top;

                    const width = endX - this.shapeStartX;
                    const height = endY - this.shapeStartY;

                    if (Math.abs(width) > 5 || Math.abs(height) > 5) {
                        const color = document.getElementById('shapeColor').value;
                        this.shapes.push({
                            type: this.currentDrawTool,
                            x: this.shapeStartX,
                            y: this.shapeStartY,
                            width: width,
                            height: height,
                            color: color,
                            filled: this.shapeFillMode
                        });
                        this.saveToLocalStorage();
                    }

                    this.isDrawingShape = false;
                    this.render();
                    return;
                }

                if (this.mode === 'select' && this.isDrawing) {
                    this.isDrawing = false;
                    this.selectSeatsInLasso();
                    this.lassoStart = null;
                    this.lassoEnd = null;
                    this.render();
                } else if (this.mode === 'move' && this.isDragging) {
                    this.isDragging = false;
                    this.dragStart = null;
                }
            }

            handleClick(e) {
                if (this.mode === 'info') {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    this.showSeatInfo(x, y);
                } else if (this.mode === 'select') {
                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    this.toggleSeatSelection(x, y);
                }
            }

            addSeatsAtPosition(startX, startY) {
                const startRowNum = parseInt(document.getElementById('startRow').value);
                const startSeatNum = parseInt(document.getElementById('startSeat').value);
                const numRows = parseInt(document.getElementById('numRows').value);
                const numSeats = parseInt(document.getElementById('numSeats').value);
                const rowSpacing = parseInt(document.getElementById('rowSpacing').value);
                const seatSpacing = parseInt(document.getElementById('seatSpacing').value);
                const orientation = document.getElementById('rowOrientation').value;
                const row1Pos = document.querySelector('input[name="row1Pos"]:checked').value;
                const seat1Pos = document.querySelector('input[name="seat1Pos"]:checked').value;
                const priceCategory = document.getElementById('priceCategory').value;
                const blockName = document.getElementById('blockName').value;
                const seatSize = this.settings.defaultSeatSize;
                const seatShape = this.settings.defaultSeatShape;

                // Calculate boundaries
                let minX = startX, maxX = startX, minY = startY, maxY = startY;

                if (orientation === 'horizontal') {
                    maxX = startX + (numSeats - 1) * (seatSize + seatSpacing) + seatSize / 2;
                    minX = startX - seatSize / 2;
                    maxY = startY + (numRows - 1) * (seatSize + rowSpacing) + seatSize / 2;
                    minY = startY - seatSize / 2;
                } else {
                    maxX = startX + (numRows - 1) * (seatSize + rowSpacing) + seatSize / 2;
                    minX = startX - seatSize / 2;
                    maxY = startY + (numSeats - 1) * (seatSize + seatSpacing) + seatSize / 2;
                    minY = startY - seatSize / 2;
                }

                // Check if seats would be outside canvas
                if (minX < 0 || minY < 0 || maxX > this.canvas.width || maxY > this.canvas.height) {
                    alert(`Fehler: Die Plätze würden außerhalb der Zeichenfläche (${this.canvas.width}x${this.canvas.height}px) platziert werden.\n\nBitte wählen Sie eine andere Position oder reduzieren Sie die Anzahl der Plätze/Abstände.`);
                    return;
                }

                this.saveState();

                for (let row = 0; row < numRows; row++) {
                    for (let seat = 0; seat < numSeats; seat++) {
                        let x, y;

                        if (orientation === 'horizontal') {
                            // Horizontal: Reihen übereinander, Plätze nebeneinander
                            const rowOffset = (row1Pos === 'top') ? row : (numRows - 1 - row);
                            const seatOffset = (seat1Pos === 'left') ? seat : (numSeats - 1 - seat);

                            // Abstand ist von Außenkante zu Außenkante (Platzgröße + gewünschter Abstand)
                            x = startX + seatOffset * (seatSize + seatSpacing);
                            y = startY + rowOffset * (seatSize + rowSpacing);
                        } else {
                            // Vertical: Reihen nebeneinander, Plätze übereinander
                            const rowOffset = (row1Pos === 'top') ? row : (numRows - 1 - row);
                            const seatOffset = (seat1Pos === 'left') ? seat : (numSeats - 1 - seat);

                            // Abstand ist von Außenkante zu Außenkante (Platzgröße + gewünschter Abstand)
                            x = startX + rowOffset * (seatSize + rowSpacing);
                            y = startY + seatOffset * (seatSize + seatSpacing);
                        }

                        const actualRow = (row1Pos === 'top' || row1Pos === 'left') ? startRowNum + row : startRowNum + (numRows - 1 - row);
                        const actualSeat = (seat1Pos === 'left' || seat1Pos === 'top') ? startSeatNum + seat : startSeatNum + (numSeats - 1 - seat);

                        this.seats.push({
                            x,
                            y,
                            block: blockName,
                            row: actualRow,
                            seat: actualSeat,
                            priceCategory,
                            size: seatSize,
                            shape: seatShape
                        });
                    }
                }

                this.render();
                this.updateStats();
                this.saveToLocalStorage();
            }

            toggleSeatSelection(x, y) {
                for (let i = 0; i < this.seats.length; i++) {
                    const seat = this.seats[i];
                    const distance = Math.sqrt((seat.x - x) ** 2 + (seat.y - y) ** 2);
                    if (distance <= seat.size / 2) {
                        if (this.selectedSeats.has(i)) {
                            this.selectedSeats.delete(i);
                        } else {
                            this.selectedSeats.add(i);
                        }
                        this.render();
                        this.updateStats();
                        break;
                    }
                }
            }

            selectSeatsInLasso() {
                if (!this.lassoStart || !this.lassoEnd) return;

                const minX = Math.min(this.lassoStart.x, this.lassoEnd.x);
                const maxX = Math.max(this.lassoStart.x, this.lassoEnd.x);
                const minY = Math.min(this.lassoStart.y, this.lassoEnd.y);
                const maxY = Math.max(this.lassoStart.y, this.lassoEnd.y);

                this.seats.forEach((seat, index) => {
                    if (seat.x >= minX && seat.x <= maxX && seat.y >= minY && seat.y <= maxY) {
                        this.selectedSeats.add(index);
                    }
                });

                this.updateStats();
            }

            showSeatInfo(x, y) {
                for (const seat of this.seats) {
                    const distance = Math.sqrt((seat.x - x) ** 2 + (seat.y - y) ** 2);
                    if (distance <= seat.size / 2) {
                        const infoDiv = document.getElementById('seatInfo');
                        infoDiv.innerHTML = `
                            <div class="info-row">
                                <span class="info-label">Block:</span>
                                <span class="info-value">${seat.block}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Reihe:</span>
                                <span class="info-value">${seat.row}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Platz:</span>
                                <span class="info-value">${seat.seat}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Preiskategorie:</span>
                                <span class="info-value">Kategorie ${seat.priceCategory}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Position:</span>
                                <span class="info-value">X: ${Math.round(seat.x)}, Y: ${Math.round(seat.y)}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Form:</span>
                                <span class="info-value">${seat.shape === 'circle' ? 'Rund' : 'Eckig'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Größe:</span>
                                <span class="info-value">${seat.size}px</span>
                            </div>
                        `;
                        break;
                    }
                }
            }

            render() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                // Draw background image
                if (this.backgroundImage) {
                    this.ctx.drawImage(this.backgroundImage, 0, 0, this.canvas.width, this.canvas.height);
                }

                // Draw shapes
                this.shapes.forEach((shape, index) => {
                    this.drawShape(shape);

                    // Highlight selected shape
                    if (index === this.selectedShape) {
                        this.ctx.strokeStyle = '#e74c3c';
                        this.ctx.lineWidth = 3;
                        this.ctx.setLineDash([5, 5]);

                        if (shape.type === 'rect') {
                            this.ctx.strokeRect(shape.x - 2, shape.y - 2, shape.width + 4, shape.height + 4);
                        } else if (shape.type === 'circle') {
                            const radius = Math.sqrt(shape.width * shape.width + shape.height * shape.height) / 2;
                            const centerX = shape.x + shape.width / 2;
                            const centerY = shape.y + shape.height / 2;
                            this.ctx.beginPath();
                            this.ctx.arc(centerX, centerY, radius + 3, 0, Math.PI * 2);
                            this.ctx.stroke();
                        }

                        this.ctx.setLineDash([]);
                    }
                });

                // Draw seats
                this.seats.forEach((seat, index) => {
                    const isSelected = this.selectedSeats.has(index);

                    this.ctx.fillStyle = this.priceColors[seat.priceCategory];
                    this.ctx.strokeStyle = isSelected ? '#333' : '#666';
                    this.ctx.lineWidth = isSelected ? 3 : 1;

                    if (seat.shape === 'circle') {
                        this.ctx.beginPath();
                        this.ctx.arc(seat.x, seat.y, seat.size / 2, 0, Math.PI * 2);
                        this.ctx.fill();
                        this.ctx.stroke();
                    } else {
                        this.ctx.fillRect(
                            seat.x - seat.size / 2,
                            seat.y - seat.size / 2,
                            seat.size,
                            seat.size
                        );
                        this.ctx.strokeRect(
                            seat.x - seat.size / 2,
                            seat.y - seat.size / 2,
                            seat.size,
                            seat.size
                        );
                    }

                    // Draw seat number
                    this.ctx.fillStyle = '#333';
                    this.ctx.font = '10px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText(seat.seat, seat.x, seat.y);
                });

                // Draw row labels AFTER seats so they are always visible
                this.drawRowLabels();

                // Draw lasso
                if (this.lassoStart && this.lassoEnd) {
                    const width = this.lassoEnd.x - this.lassoStart.x;
                    const height = this.lassoEnd.y - this.lassoStart.y;

                    this.ctx.strokeStyle = '#667eea';
                    this.ctx.lineWidth = 2;
                    this.ctx.setLineDash([5, 5]);
                    this.ctx.strokeRect(this.lassoStart.x, this.lassoStart.y, width, height);

                    this.ctx.fillStyle = 'rgba(102, 126, 234, 0.1)';
                    this.ctx.fillRect(this.lassoStart.x, this.lassoStart.y, width, height);

                    this.ctx.setLineDash([]);
                }
            }

            drawRowLabels() {
                // Group seats by block and row
                const blockRows = {};
                this.seats.forEach(seat => {
                    const key = `${seat.block}_${seat.row}`;
                    if (!blockRows[key]) {
                        blockRows[key] = {
                            block: seat.block,
                            row: seat.row,
                            seats: []
                        };
                    }
                    blockRows[key].seats.push(seat);
                });

                // Draw labels for each row
                this.ctx.fillStyle = '#333';
                this.ctx.font = 'bold 14px Arial';
                this.ctx.textBaseline = 'middle';

                Object.values(blockRows).forEach(rowData => {
                    if (rowData.seats.length === 0) return;

                    const seats = rowData.seats;
                    if (seats.length < 1) return;

                    // Sort seats by seat number to find first and last
                    const sortedSeats = [...seats].sort((a, b) => a.seat - b.seat);
                    const firstSeat = sortedSeats[0];
                    const lastSeat = sortedSeats[sortedSeats.length - 1];

                    const label = `${rowData.row}`;

                    // Calculate spacing between seats if we have at least 2 seats
                    let seatSpacingX = 0;
                    let seatSpacingY = 0;

                    if (seats.length >= 2) {
                        // Calculate average spacing between consecutive seats
                        seatSpacingX = (lastSeat.x - firstSeat.x) / (seats.length - 1);
                        seatSpacingY = (lastSeat.y - firstSeat.y) / (seats.length - 1);
                    }

                    // Position labels as if they were seats before first and after last
                    // Left label: one seat position before the first seat
                    const labelLeftX = firstSeat.x - seatSpacingX * 1.2;
                    const labelLeftY = firstSeat.y - seatSpacingY * 1.2;

                    if (labelLeftX > 10 && labelLeftX < this.canvas.width - 10 &&
                        labelLeftY > 15 && labelLeftY < this.canvas.height - 15) {

                        this.ctx.save();
                        this.ctx.translate(labelLeftX, labelLeftY);
                        this.ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                        const textWidth = this.ctx.measureText(label).width;
                        this.ctx.fillRect(-textWidth / 2 - 4, -10, textWidth + 8, 20);
                        this.ctx.fillStyle = '#333';
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText(label, 0, 0);
                        this.ctx.restore();
                    }

                    // Right label: one seat position after the last seat
                    const labelRightX = lastSeat.x + seatSpacingX * 1.2;
                    const labelRightY = lastSeat.y + seatSpacingY * 1.2;

                    if (labelRightX > 10 && labelRightX < this.canvas.width - 10 &&
                        labelRightY > 15 && labelRightY < this.canvas.height - 15) {

                        this.ctx.save();
                        this.ctx.translate(labelRightX, labelRightY);
                        this.ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                        const textWidth = this.ctx.measureText(label).width;
                        this.ctx.fillRect(-textWidth / 2 - 4, -10, textWidth + 8, 20);
                        this.ctx.fillStyle = '#333';
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText(label, 0, 0);
                        this.ctx.restore();
                    }
                });
            }

            toggleDrawMode(tool) {
                // Clear all draw button active states
                document.getElementById('btnRect').classList.remove('active');
                document.getElementById('btnCircle').classList.remove('active');
                document.getElementById('btnLine').classList.remove('active');
                document.getElementById('btnTriangle').classList.remove('active');

                // If clicking the same tool, deactivate it
                if (this.currentDrawTool === tool) {
                    this.currentDrawTool = null;
                    this.mode = 'info';
                    this.selectedShape = null;
                    document.getElementById('modeIndicator').textContent = 'Modus: Info anzeigen (Klicken Sie auf einen Platz)';
                    this.canvas.style.cursor = 'help';
                } else {
                    // Activate the selected tool
                    this.currentDrawTool = tool;
                    this.mode = null;
                    this.selectedSeats.clear();
                    this.selectedShape = null;

                    // Add active class to the clicked button
                    const buttonId = tool === 'rect' ? 'btnRect' :
                                   tool === 'circle' ? 'btnCircle' :
                                   tool === 'line' ? 'btnLine' : 'btnTriangle';
                    document.getElementById(buttonId).classList.add('active');

                    const toolName = tool === 'rect' ? 'Rechteck' :
                                   tool === 'circle' ? 'Kreis' :
                                   tool === 'line' ? 'Linie' : 'Dreieck';
                    document.getElementById('modeIndicator').textContent = `Modus: ${toolName} zeichnen`;
                }

                this.render();
            }

            setDrawMode(tool) {
                // Keep for backward compatibility, but use toggleDrawMode instead
                this.toggleDrawMode(tool);
            }

            drawShape(shape) {
                this.ctx.strokeStyle = shape.color;
                this.ctx.fillStyle = shape.color;
                this.ctx.lineWidth = 3;

                if (shape.type === 'rect') {
                    if (shape.filled) {
                        this.ctx.fillRect(shape.x, shape.y, shape.width, shape.height);
                    } else {
                        this.ctx.strokeRect(shape.x, shape.y, shape.width, shape.height);
                    }
                } else if (shape.type === 'circle') {
                    const radius = Math.sqrt(shape.width * shape.width + shape.height * shape.height) / 2;
                    const centerX = shape.x + shape.width / 2;
                    const centerY = shape.y + shape.height / 2;
                    this.ctx.beginPath();
                    this.ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                    if (shape.filled) {
                        this.ctx.fill();
                    } else {
                        this.ctx.stroke();
                    }
                } else if (shape.type === 'line') {
                    this.ctx.beginPath();
                    this.ctx.moveTo(shape.x, shape.y);
                    this.ctx.lineTo(shape.x + shape.width, shape.y + shape.height);
                    this.ctx.stroke();
                } else if (shape.type === 'triangle') {
                    this.ctx.beginPath();
                    this.ctx.moveTo(shape.x + shape.width / 2, shape.y);
                    this.ctx.lineTo(shape.x, shape.y + shape.height);
                    this.ctx.lineTo(shape.x + shape.width, shape.y + shape.height);
                    this.ctx.closePath();
                    if (shape.filled) {
                        this.ctx.fill();
                    } else {
                        this.ctx.stroke();
                    }
                }
            }

            drawShapePreview(x1, y1, x2, y2) {
                const color = document.getElementById('shapeColor').value;
                this.ctx.strokeStyle = color;
                this.ctx.fillStyle = color;
                this.ctx.lineWidth = 3;
                this.ctx.globalAlpha = 0.5;

                const width = x2 - x1;
                const height = y2 - y1;

                if (this.currentDrawTool === 'rect') {
                    if (this.shapeFillMode) {
                        this.ctx.fillRect(x1, y1, width, height);
                    } else {
                        this.ctx.strokeRect(x1, y1, width, height);
                    }
                } else if (this.currentDrawTool === 'circle') {
                    const radius = Math.sqrt(width * width + height * height) / 2;
                    const centerX = x1 + width / 2;
                    const centerY = y1 + height / 2;
                    this.ctx.beginPath();
                    this.ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                    if (this.shapeFillMode) {
                        this.ctx.fill();
                    } else {
                        this.ctx.stroke();
                    }
                } else if (this.currentDrawTool === 'line') {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x1, y1);
                    this.ctx.lineTo(x2, y2);
                    this.ctx.stroke();
                } else if (this.currentDrawTool === 'triangle') {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x1 + width / 2, y1);
                    this.ctx.lineTo(x1, y1 + height);
                    this.ctx.lineTo(x1 + width, y1 + height);
                    this.ctx.closePath();
                    if (this.shapeFillMode) {
                        this.ctx.fill();
                    } else {
                        this.ctx.stroke();
                    }
                }

                this.ctx.globalAlpha = 1.0;
            }

            toggleFillMode() {
                this.shapeFillMode = !this.shapeFillMode;
                const btn = document.getElementById('fillModeBtn');
                if (this.shapeFillMode) {
                    btn.classList.add('btn-success');
                } else {
                    btn.classList.remove('btn-success');
                }
            }

            isPointInShape(x, y, shape) {
                if (shape.type === 'rect') {
                    return x >= shape.x && x <= shape.x + shape.width &&
                           y >= shape.y && y <= shape.y + shape.height;
                } else if (shape.type === 'circle') {
                    const centerX = shape.x + shape.width / 2;
                    const centerY = shape.y + shape.height / 2;
                    const radius = Math.sqrt(shape.width * shape.width + shape.height * shape.height) / 2;
                    const distance = Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2);
                    return distance <= radius;
                } else if (shape.type === 'triangle') {
                    return x >= shape.x && x <= shape.x + shape.width &&
                           y >= shape.y && y <= shape.y + shape.height;
                } else if (shape.type === 'line') {
                    const dist = this.distanceToLine(x, y, shape.x, shape.y,
                        shape.x + shape.width, shape.y + shape.height);
                    return dist < 10;
                }
                return false;
            }

            distanceToLine(px, py, x1, y1, x2, y2) {
                const A = px - x1;
                const B = py - y1;
                const C = x2 - x1;
                const D = y2 - y1;
                const dot = A * C + B * D;
                const lenSq = C * C + D * D;
                const param = lenSq !== 0 ? dot / lenSq : -1;

                let xx, yy;
                if (param < 0) {
                    xx = x1;
                    yy = y1;
                } else if (param > 1) {
                    xx = x2;
                    yy = y2;
                } else {
                    xx = x1 + param * C;
                    yy = y1 + param * D;
                }

                const dx = px - xx;
                const dy = py - yy;
                return Math.sqrt(dx * dx + dy * dy);
            }

            deleteSelectedShape() {
                if (this.selectedShape !== null) {
                    if (confirm('Form löschen?')) {
                        this.shapes.splice(this.selectedShape, 1);
                        this.selectedShape = null;
                        this.render();
                        this.saveToLocalStorage();
                    }
                } else {
                    alert('Bitte wählen Sie zuerst eine Form aus.');
                }
            }

            loadBackgroundImage(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        this.backgroundImage = img;
                        this.render();
                        this.saveToLocalStorage();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            removeBackgroundImage() {
                this.backgroundImage = null;
                localStorage.removeItem('saalplan_background');
                this.render();
            }

            setMode(mode) {
                this.mode = mode;
                this.currentDrawTool = null;

                // Clear all draw button active states when switching to another mode
                document.getElementById('btnRect').classList.remove('active');
                document.getElementById('btnCircle').classList.remove('active');
                document.getElementById('btnLine').classList.remove('active');
                document.getElementById('btnTriangle').classList.remove('active');

                if (mode !== 'move' && mode !== 'select') {
                    this.selectedSeats.clear();
                }
                const indicator = document.getElementById('modeIndicator');
                const selectionActions = document.getElementById('selectionActions');

                switch(mode) {
                    case 'add':
                        indicator.textContent = 'Modus: Plätze hinzufügen (Klicken Sie auf die gewünschte Position)';
                        this.canvas.style.cursor = 'crosshair';
                        selectionActions.style.display = 'none';
                        break;
                    case 'select':
                        indicator.textContent = 'Modus: Plätze auswählen (Lasso ziehen oder einzeln klicken)';
                        this.canvas.style.cursor = 'pointer';
                        selectionActions.style.display = 'flex';
                        break;
                    case 'move':
                        indicator.textContent = 'Modus: Plätze verschieben (Ziehen Sie die ausgewählten Plätze)';
                        this.canvas.style.cursor = 'move';
                        selectionActions.style.display = 'flex';
                        break;
                    case 'info':
                        indicator.textContent = 'Modus: Info anzeigen (Klicken Sie auf einen Platz)';
                        this.canvas.style.cursor = 'help';
                        selectionActions.style.display = 'none';
                        break;
                }

                this.render();
                this.updateStats();
            }

            openRotateModal() {
                if (this.selectedSeats.size === 0) {
                    alert('Bitte wählen Sie zunächst Plätze aus.');
                    return;
                }
                document.getElementById('rotateModal').classList.add('active');
            }

            closeRotateModal() {
                const modal = document.getElementById('rotateModal');
                if (modal) {
                    modal.classList.remove('active');
                }
            }

            applyRotation() {
                const angle = parseFloat(document.getElementById('rotationAngle').value);
                this.rotateSelected(angle);
                this.closeRotateModal();
            }

            rotateSelected(angle) {
                if (this.selectedSeats.size === 0) {
                    alert('Bitte wählen Sie zunächst Plätze aus.');
                    return;
                }

                this.saveState();

                // Calculate center point of selection
                const selectedIndices = Array.from(this.selectedSeats);
                const centerX = selectedIndices.reduce((sum, i) => sum + this.seats[i].x, 0) / selectedIndices.length;
                const centerY = selectedIndices.reduce((sum, i) => sum + this.seats[i].y, 0) / selectedIndices.length;

                // Convert angle to radians
                const rad = (angle * Math.PI) / 180;
                const cos = Math.cos(rad);
                const sin = Math.sin(rad);

                // Rotate each selected seat around the center point
                selectedIndices.forEach(index => {
                    const seat = this.seats[index];

                    // Translate to origin
                    const dx = seat.x - centerX;
                    const dy = seat.y - centerY;

                    // Rotate
                    const rotatedX = dx * cos - dy * sin;
                    const rotatedY = dx * sin + dy * cos;

                    // Translate back
                    seat.x = centerX + rotatedX;
                    seat.y = centerY + rotatedY;
                });

                this.render();
                this.saveToLocalStorage();
            }

            changeSelectedCategory() {
                if (this.selectedSeats.size === 0) {
                    alert('Bitte wählen Sie zunächst Plätze aus.');
                    return;
                }

                // Create modal
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-header">
                            <h3>Preiskategorie ändern</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div class="form-group">
                            <label>Neue Preiskategorie</label>
                            <select id="newPriceCategory" style="width: 100%;">
                                <option value="1">Kategorie 1 (Premium)</option>
                                <option value="2">Kategorie 2 (Standard)</option>
                                <option value="3">Kategorie 3 (Budget)</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button onclick="this.closest('.modal').remove()" class="btn-secondary">Abbrechen</button>
                            <button onclick="editor.applyCategoryChange()" class="btn-success">Übernehmen</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            applyCategoryChange() {
                const newCategory = document.getElementById('newPriceCategory').value;
                this.saveState();
                this.selectedSeats.forEach(index => {
                    this.seats[index].priceCategory = newCategory;
                });
                this.render();
                this.saveToLocalStorage();

                // Close modal
                const modal = document.querySelector('.modal.active');
                if (modal) modal.remove();
            }

            deleteSelected() {
                if (this.selectedSeats.size === 0) {
                    alert('Bitte wählen Sie zunächst Plätze aus.');
                    return;
                }

                if (confirm(`Möchten Sie ${this.selectedSeats.size} Plätze löschen?`)) {
                    this.saveState();
                    const indicesToDelete = Array.from(this.selectedSeats).sort((a, b) => b - a);
                    indicesToDelete.forEach(index => {
                        this.seats.splice(index, 1);
                    });
                    this.selectedSeats.clear();
                    this.render();
                    this.updateStats();
                    this.saveToLocalStorage();
                }
            }

            saveState() {
                this.history.push(JSON.parse(JSON.stringify(this.seats)));
                if (this.history.length > 50) {
                    this.history.shift();
                }
                document.getElementById('undoBtn').disabled = false;
            }

            undo() {
                if (this.history.length > 0) {
                    this.seats = this.history.pop();
                    this.selectedSeats.clear();
                    this.render();
                    this.updateStats();
                    this.saveToLocalStorage();

                    if (this.history.length === 0) {
                        document.getElementById('undoBtn').disabled = true;
                    }
                }
            }

            updateStats() {
                document.getElementById('totalSeats').textContent = this.seats.length;
                document.getElementById('selectedSeats').textContent = this.selectedSeats.size;
            }

            exportJSON() {
                const data = {
                    seats: this.seats,
                    metadata: {
                        created: new Date().toISOString(),
                        totalSeats: this.seats.length
                    }
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `saalplan_${new Date().getTime()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            importJSON(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.seats && Array.isArray(data.seats)) {
                            this.saveState();
                            this.seats = data.seats;
                            this.selectedSeats.clear();
                            this.render();
                            this.updateStats();
                            this.saveToLocalStorage();
                            alert('Saalplan erfolgreich geladen!');
                        } else {
                            alert('Ungültiges Dateiformat!');
                        }
                    } catch (error) {
                        alert('Fehler beim Laden der Datei: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }

            exportPDF() {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'px',
                    format: [this.canvas.width, this.canvas.height]
                });

                // Add canvas to PDF
                const imgData = this.canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 0, 0, this.canvas.width, this.canvas.height);

                // Add legend
                pdf.setFontSize(12);
                pdf.text('Saalplan - Legende', 20, this.canvas.height - 60);
                
                const categories = [
                    { cat: '1', color: '#ff6b6b', name: 'Kategorie 1 (Premium)' },
                    { cat: '2', color: '#4ecdc4', name: 'Kategorie 2 (Standard)' },
                    { cat: '3', color: '#95e1d3', name: 'Kategorie 3 (Budget)' }
                ];

                categories.forEach((item, index) => {
                    pdf.setFillColor(item.color);
                    pdf.rect(20, this.canvas.height - 40 + (index * 15), 10, 10, 'F');
                    pdf.text(item.name, 35, this.canvas.height - 32 + (index * 15));
                });

                pdf.save(`saalplan_${new Date().getTime()}.pdf`);
            }

            clearCanvas() {
                if (this.seats.length === 0 && this.shapes.length === 0) return;

                if (confirm('Möchten Sie wirklich alle Plätze und Formen löschen?')) {
                    this.saveState();
                    this.seats = [];
                    this.shapes = [];
                    this.selectedSeats.clear();
                    this.selectedShape = null;
                    this.render();
                    this.updateStats();
                    this.saveToLocalStorage();
                }
            }
        }

        // Initialize editor
        const editor = new SeatPlanEditor();
    </script>
</body>
</html>